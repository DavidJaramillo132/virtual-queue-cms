<!-- Burbuja flotante -->
<div 
  (click)="toggleChat()"
  class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:scale-110 transition-all duration-300 z-50"
  [class.bg-red-500]="isOpen()"
>
  @if (!isOpen()) {
    <fa-icon [icon]="faCommentDots" class="text-white text-2xl"></fa-icon>
  } @else {
    <fa-icon [icon]="faTimes" class="text-white text-2xl"></fa-icon>
  }
</div>

<!-- Ventana de chat -->
@if (isOpen()) {
  <div class="fixed bottom-28 right-6 w-96 h-[550px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden z-40 animate-slide-up">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
          <fa-icon [icon]="faRobot" class="text-lg"></fa-icon>
        </div>
        <div>
          <h3 class="font-semibold text-base">Asistente Virtual</h3>
          <p class="text-xs opacity-90">En lÃ­nea</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button 
          (click)="reiniciarChat()" 
          class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all"
          title="Nueva cita"
        >
          <span class="text-sm font-semibold">ðŸ”„</span>
        </button>
        <button 
          (click)="clearChat()" 
          class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all"
          title="Limpiar chat"
        >
          <fa-icon [icon]="faTrash" class="text-sm"></fa-icon>
        </button>
        <button 
          (click)="closeChat()" 
          class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all"
          title="Cerrar"
        >
          <fa-icon [icon]="faTimes" class="text-sm"></fa-icon>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div class="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4 chat-messages">
      @for (message of messages(); track $index) {
        <div class="flex gap-2" [class.flex-row-reverse]="message.role === 'user'">
          <!-- Avatar -->
          <div 
            class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"
            [class.bg-purple-600]="message.role === 'user'"
            [class.bg-gray-300]="message.role === 'assistant'"
          >
            <fa-icon 
              [icon]="message.role === 'user' ? faUser : faRobot" 
              class="text-xs"
              [class.text-white]="message.role === 'user'"
              [class.text-gray-600]="message.role === 'assistant'"
            ></fa-icon>
          </div>

          <!-- Message Content -->
          <div class="max-w-[70%]">
            <div 
              class="px-4 py-2 rounded-xl"
              [class.bg-purple-600]="message.role === 'user'"
              [class.text-white]="message.role === 'user'"
              [class.rounded-br-sm]="message.role === 'user'"
              [class.bg-white]="message.role === 'assistant'"
              [class.text-gray-800]="message.role === 'assistant'"
              [class.rounded-bl-sm]="message.role === 'assistant'"
              [class.shadow-sm]="message.role === 'assistant'"
            >
              <p class="text-sm whitespace-pre-wrap break-words">{{ message.content }}</p>
            </div>
            
            <!-- Opciones de botones -->
            @if (message.options && message.options.length > 0) {
              <div class="flex flex-col gap-2 mt-2">
                @for (option of message.options; track $index) {
                  <button 
                    (click)="onOptionClick(option)"
                    class="px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-500 text-white text-sm rounded-lg hover:from-purple-600 hover:to-indigo-600 transition-all shadow-sm hover:shadow-md text-left"
                  >
                    {{ option.label }}
                  </button>
                }
              </div>
            }
            
            <span class="text-xs text-gray-500 mt-1 block" [class.text-right]="message.role === 'user'">
              {{ message.timestamp | date: 'short' }}
            </span>
          </div>
        </div>
      }
      
      <!-- Loading indicator -->
      @if (isLoading()) {
        <div class="flex gap-2">
          <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
            <fa-icon [icon]="faRobot" class="text-xs text-gray-600"></fa-icon>
          </div>
          <div class="bg-white px-4 py-3 rounded-xl rounded-bl-sm shadow-sm">
            <div class="flex gap-1">
              <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
              <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
              <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Input -->
    <div class="p-4 bg-white border-t border-gray-200 flex gap-2">
      <input 
        type="text" 
        [(ngModel)]="currentMessage"
        (keypress)="onKeyPress($event)"
        placeholder="Escribe tu mensaje..."
        [disabled]="isLoading()"
        class="flex-1 px-4 py-2 border border-gray-300 rounded-full text-sm outline-none focus:border-purple-600 focus:ring-2 focus:ring-purple-200 disabled:bg-gray-100 disabled:cursor-not-allowed transition-all"
      />
      <button 
        (click)="sendMessage()" 
        [disabled]="!currentMessage().trim() || isLoading()"
        class="w-10 h-10 rounded-full bg-purple-600 text-white flex items-center justify-center hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all"
      >
        <fa-icon [icon]="faPaperPlane" class="text-sm"></fa-icon>
      </button>
    </div>

  </div>
}
