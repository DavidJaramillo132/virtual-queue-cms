<!-- Burbuja flotante -->
<div 
  (click)="toggleChat()"
  class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-gray-900 to-black rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:scale-110 transition-all duration-300 z-50"
  [class.bg-gray-700]="isOpen()"
>
  @if (!isOpen()) {
    <fa-icon [icon]="faCommentDots" class="text-white text-2xl"></fa-icon>
  } @else {
    <fa-icon [icon]="faTimes" class="text-white text-2xl"></fa-icon>
  }
</div>

<!-- Ventana de chat -->
@if (isOpen()) {
  <div class="fixed bottom-28 right-6 w-96 h-[550px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden z-40 animate-slide-up">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-gray-900 to-black text-white p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
          <fa-icon [icon]="faRobot" class="text-lg"></fa-icon>
        </div>
        <div>
          <h3 class="font-semibold text-base">Asistente Virtual</h3>
          <p class="text-xs opacity-90">En lÃ­nea</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button 
          (click)="reiniciarChat()" 
          class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all"
          title="Nueva cita"
        >
          <span class="text-sm font-semibold">ðŸ”„</span>
        </button>
        <button 
          (click)="clearChat()" 
          class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all"
          title="Limpiar chat"
        >
          <fa-icon [icon]="faTrash" class="text-sm"></fa-icon>
        </button>
        <button 
          (click)="closeChat()" 
          class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition-all"
          title="Cerrar"
        >
          <fa-icon [icon]="faTimes" class="text-sm"></fa-icon>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div class="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4 chat-messages">
      @for (message of messages(); track $index) {
        <div class="flex gap-2" [class.flex-row-reverse]="message.role === 'user'">
          <!-- Avatar -->
          <div 
            class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"
            [class.bg-gray-900]="message.role === 'user'"
            [class.bg-gray-300]="message.role === 'assistant'"
          >
            <fa-icon 
              [icon]="message.role === 'user' ? faUser : faRobot" 
              class="text-xs"
              [class.text-white]="message.role === 'user'"
              [class.text-gray-600]="message.role === 'assistant'"
            ></fa-icon>
          </div>

          <!-- Message Content -->
          <div class="max-w-[70%]">
            <div 
              class="px-4 py-2 rounded-xl"
              [class.bg-gray-900]="message.role === 'user'"
              [class.text-white]="message.role === 'user'"
              [class.rounded-br-sm]="message.role === 'user'"
              [class.bg-white]="message.role === 'assistant'"
              [class.text-gray-800]="message.role === 'assistant'"
              [class.rounded-bl-sm]="message.role === 'assistant'"
              [class.shadow-sm]="message.role === 'assistant'"
            >
              <p class="text-sm whitespace-pre-wrap break-words">{{ message.content }}</p>
            </div>
            
            <!-- Opciones de botones -->
            @if (message.options && message.options.length > 0) {
              <div class="flex flex-col gap-2 mt-2">
                @for (option of message.options; track $index) {
                  <button 
                    (click)="onOptionClick(option)"
                    class="px-4 py-2 bg-gradient-to-r from-gray-900 to-black text-white text-sm rounded-lg hover:from-gray-800 hover:to-gray-900 transition-all shadow-sm hover:shadow-md text-left"
                  >
                    {{ option.label }}
                  </button>
                }
              </div>
            }
            
            <span class="text-xs text-gray-500 mt-1 block" [class.text-right]="message.role === 'user'">
              {{ message.timestamp | date: 'short' }}
            </span>
          </div>
        </div>
      }
      
      <!-- Loading indicator -->
      @if (isLoading()) {
        <div class="flex gap-2">
          <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
            <fa-icon [icon]="faRobot" class="text-xs text-gray-600"></fa-icon>
          </div>
          <div class="bg-white px-4 py-3 rounded-xl rounded-bl-sm shadow-sm">
            <div class="flex gap-1">
              <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
              <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
              <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Input -->
    <div class="p-4 bg-white border-t border-gray-200">
      <!-- File preview -->
      @if (selectedFile()) {
        <div class="mb-2 p-3 bg-gray-50 border border-gray-300 rounded-lg flex items-center justify-between">
          <div class="flex items-center gap-2">
            @if (selectedFile() && selectedFile()!.type.includes('pdf')) {
              <fa-icon [icon]="faFilePdf" class="text-red-500 text-xl"></fa-icon>
            } @else {
              @if (filePreview()) {
                <img [src]="filePreview()" alt="Preview" class="w-12 h-12 object-cover rounded"/>
              } @else {
                <fa-icon [icon]="faImage" class="text-blue-500 text-xl"></fa-icon>
              }
            }
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-700">{{ selectedFile()!.name }}</p>
              <p class="text-xs text-gray-500">{{ (selectedFile()!.size / 1024).toFixed(1) }} KB</p>
            </div>
          </div>
          <button 
            (click)="clearFileSelection()"
            class="text-red-500 hover:text-red-700 p-1"
          >
            <fa-icon [icon]="faTimes" class="text-sm"></fa-icon>
          </button>
        </div>
      }
      
      <div class="flex gap-2">
        <!-- Hidden file input -->
        <input 
          #fileInput
          type="file" 
          (change)="onFileSelected($event)"
          accept=".pdf,.jpg,.jpeg,.png,.webp"
          class="hidden"
        />
        
        <!-- File attachment button -->
        <button 
          (click)="triggerFileInput()"
          [disabled]="isLoading()"
          class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 disabled:bg-gray-100 disabled:cursor-not-allowed transition-all"
          title="Adjuntar archivo (PDF o imagen)"
        >
          <fa-icon [icon]="faPaperclip" class="text-sm"></fa-icon>
        </button>
        
        <input 
          type="text" 
          [(ngModel)]="currentMessage"
          (keypress)="onKeyPress($event)"
          [placeholder]="selectedFile() ? 'Mensaje opcional...' : 'Escribe tu mensaje o adjunta un archivo...'"
          [disabled]="isLoading()"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-full text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-200 disabled:bg-gray-100 disabled:cursor-not-allowed transition-all"
        />
        <button 
          (click)="sendMessage()" 
          [disabled]="(!currentMessage().trim() && !selectedFile()) || isLoading()"
          class="w-10 h-10 rounded-full bg-gray-900 text-white flex items-center justify-center hover:bg-black disabled:bg-gray-300 disabled:cursor-not-allowed transition-all"
        >
          <fa-icon [icon]="faPaperPlane" class="text-sm"></fa-icon>
        </button>
      </div>
    </div>

  </div>
}
