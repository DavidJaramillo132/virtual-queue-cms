<div class="p-4 max-w-3xl mx-auto">
  <h2 class="text-2xl font-bold mb-4">Cola de citas de hoy</h2>

  <!-- Tabla de citas - solo visible cuando hay servicio y estación seleccionados -->
  <div *ngIf="servicio_seleccionado && estacionSeleccionadaId" class="border rounded-lg overflow-hidden mb-6 shadow">
    <table class="w-full text-left border-collapse">
      <thead class="bg-gray-100">
        <tr>
          <th class="border p-2">#</th>
          <th class="border p-2">Hora Inicio</th>
          <th class="border p-2">Hora Fin</th>
          <th class="border p-2">Estado</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cita of citas; let i = index">
          <td class="border p-2">{{ i + 1 }}</td>
          <td class="border p-2">{{ cita.hora_inicio }}</td>
          <td class="border p-2">{{ cita.hora_fin }}</td>
          <td class="border p-2">{{ cita.estado }}</td>
        </tr>
        <tr *ngIf="citas.length === 0 && !loading">
          <td colspan="4" class="border p-2 text-center text-gray-500">No hay citas hoy</td>
        </tr>
        <tr *ngIf="loading">
          <td colspan="4" class="border p-2 text-center text-gray-500">Cargando citas...</td>
        </tr>
      </tbody>
    </table>
  </div>
 
  <form [formGroup]="nuevaCitaForm">
    <div class="mb-4">
      <label for="servicio" class="block mb-2">
        <p class="font-semibold">Servicio:</p>
        <div *ngIf="servicioPreseleccionado" class="border p-3 rounded w-full bg-gray-50">
          <p class="font-medium">{{ servicioPreseleccionado.nombre }}</p>
          <p class="text-sm text-gray-600">Duración: {{ servicioPreseleccionado.duracion_minutos }} minutos</p>
          <p *ngIf="servicioPreseleccionado.descripcion" class="text-sm text-gray-500 mt-1">{{ servicioPreseleccionado.descripcion }}</p>
        </div>
        <select 
          *ngIf="!servicioPreseleccionado"
          id="servicio" 
          formControlName="servicio_id"
          (change)="onServicioSeleccionado($event)"
          class="border p-2 rounded w-full"
        >
          <option value="">-- Seleccione un servicio --</option>
          <option *ngFor="let servicio of servicios" [value]="servicio.id">
            {{ servicio.nombre }} ({{ servicio.duracion_minutos }} min)
          </option>
        </select>
      </label>
    </div>

    <!-- Selector de Estación (Fila) - solo habilitado después de seleccionar servicio -->
    <div class="mb-4">
      <label for="estacion" class="block mb-2">
        <p class="font-semibold">Fila (Estación):<span class="text-red-500">*</span></p>
        <select 
          id="estacion"
          formControlName="estacion_id"
          (change)="onEstacionSeleccionada($event)"
          class="border p-2 rounded w-full"
          [class.border-red-500]="nuevaCitaForm.get('estacion_id')?.invalid && nuevaCitaForm.get('estacion_id')?.touched"
        >
          <option value="">-- Seleccione una fila --</option>
          <option *ngFor="let estacion of estaciones" [value]="estacion.id">
            {{ estacion.nombre }} {{ estacion.tipo ? '(' + estacion.tipo + ')' : '' }}
          </option>
        </select>
        <p *ngIf="!servicio_seleccionado" class="text-sm text-gray-500 mt-1">
          Primero debe seleccionar un servicio
        </p>
        <p *ngIf="servicio_seleccionado && estaciones.length === 0" class="text-sm text-red-500 mt-1 font-medium">
          Este negocio aún no ha creado filas de atención. Por favor, contacte al negocio.
        </p>
        <p *ngIf="servicio_seleccionado && estaciones.length > 0" class="text-sm text-gray-500 mt-1">
          Seleccione una fila para ver las citas disponibles
        </p>
      </label>
    </div>
  </form>

  <!-- Mensajes de estado -->
  <div *ngIf="errorMessage" class="mb-4 p-4 bg-red-50 text-red-700 rounded-lg">
    {{ errorMessage }}
  </div>
  
  <div *ngIf="successMessage" class="mb-4 p-4 bg-green-50 text-green-700 rounded-lg">
    {{ successMessage }}
  </div>

  <label for="hora_inicio" *ngIf="servicio_seleccionado && estacionSeleccionadaId">
    <p>Hora de inicio:<span class="text-red-500">*</span></p>
    <select
      id="hora_inicio"
      [(ngModel)]="hora_inicio"
      (ngModelChange)="onHoraInicioChange()"
      class="border p-2 rounded mr-4"
      [disabled]="horasDisponibles.length === 0"
    >
      <option value="">-- Seleccione una hora disponible prueba de cambio --</option>
      <option *ngFor="let hora of horasDisponibles" [value]="hora">
        {{ hora }}
      </option>
    </select>
    <p *ngIf="horasDisponibles.length === 0 && servicio_seleccionado && estacionSeleccionadaId" class="text-sm text-red-500 mt-1">
      No hay horas disponibles para hoy en esta fila
    </p>
  </label>
  <label for="Tiempo_servicio">
    <p>Tiempo de servicio:</p>
    <input
      type="time"
      id="hora_fin"
      [(ngModel)]="hora_fin"
      readonly
      class="border p-2 rounded mr-4 bg-gray-100"
    />
  </label>
  
  <button
    (click)="agregarCita()"
    class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
    [disabled]="loading || !hora_inicio || !servicio_seleccionado || nuevaCitaForm.get('estacion_id')?.invalid"
  >
    {{ loading ? 'Agendando...' : 'Agregar al final de la cola' }}
  </button>
</div>
