services:
  # Servicio REST (TypeScript) - API principal que conecta con Token Service
  rest-typescript:
    build: 
      context: ./backend/services/rest-typescript
      dockerfile: Dockerfile
    command: npm run dev
    container_name: rest-typescript
    restart: always
    ports:
      - "3000:3000"
    env_file:
      - ./backend/services/rest-typescript/.env
    environment:
      - NODE_ENV=development
      - PORT=3000
      - TOKEN_SERVICE_URL=http://token-service:4000
      # JWT_SECRET compartido para validacion local de tokens (mismo que token-service)
      - JWT_SECRET=clave123
    depends_on:
      - token-service
    networks:
      - app-net
    volumes:
      - ./backend/services/rest-typescript:/app
      - /app/node_modules

  # Servicio GraphQL (Python)
  graphql-service:
    build: 
      context: ./backend/services/GraphQL_Service
      dockerfile: Dockerfile
    container_name: graphql-service
    restart: always
    ports:
      - "5000:5000"
    env_file:
      - ./backend/services/GraphQL_Service/.env
    environment:
      - REST_API_URL=http://rest-typescript:3000
    depends_on:
      - rest-typescript
      - token-service
    networks:
      - app-net
    volumes:
      - ./backend/services/GraphQL_Service:/app

  # Servicio WebSocket (Go) - Comunicacion en tiempo real
  websocket-server:
    build: 
      context: ./backend/services/websocket-server
      dockerfile: Dockerfile
    container_name: websocket-server
    restart: always
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://postgres.ahyeuobiaxqzezqubjox:J5SBRXQBNa2nVAU9@aws-1-us-east-1.pooler.supabase.com:6543/postgres?sslmode=require
      # JWT_SECRET compartido para validacion local de tokens (mismo que token-service)
      - JWT_SECRET=clave123
      - PORT=8080
      - REST_API_URL=http://rest-typescript:3000
      - ALLOWED_ORIGINS=http://localhost:4200
    depends_on:
      - rest-typescript
      - token-service
    networks:
      - app-net

  # Servicio Token (Node) - Microservicio de Autenticacion independiente (Pilar 1)
  # IMPORTANTE: JWT_SECRET debe ser el mismo en todos los servicios que validan tokens
  token-service:
    build:
      context: ./microservicios/Token
      dockerfile: Dockerfile
    container_name: token-service
    restart: always
    ports:
      - "4000:4000"
    environment:
      # Secreto compartido para firmar/verificar JWT (debe coincidir con rest-typescript y websocket-server)
      - JWT_SECRET=clave123
      - PORT=4000
      # Duracion del access token (recomendado: 15m a 30m para seguridad)
      - ACCESS_EXPIRES=30m
      # Dias de validez del refresh token
      - REFRESH_EXPIRES_DAYS=30
      # Intervalo de limpieza de tokens expirados (1 hora = 3600000 ms)
      - CLEANUP_INTERVAL_MS=3600000
    volumes:
      # Volumen para persistir la base de datos SQLite entre reinicios
      - token-data:/app/data
    networks:
      - app-net

  # Microservicio MCP (Python)
  mcp-service:
    build: 
      context: ./microservicios/MCP
      dockerfile: Dockerfile
    container_name: mcp-service
    restart: always
    ports:
      - "8001:8000"
    env_file:
      - ./microservicios/MCP/.env
    environment:
      - TZ=America/Guayaquil
    networks:
      - app-net
    volumes:
      - ./microservicios/MCP:/app

  # Microservicio Payments (Python)
  payments-service:
    build: 
      context: ./microservicios/payment
      dockerfile: Dockerfile
    container_name: payments-service
    restart: always
    ports:
      - "8002:8000"
    env_file:
      - ./microservicios/payment/.env
    environment:
      - TZ=America/Guayaquil
    networks:
      - app-net
    volumes:
      - ./microservicios/payment:/app


  # Frontend (Angular)
  frontend:
    build: 
      context: ./frontend/virtual-queue-cms
      dockerfile: Dockerfile
    command: npm run start
    container_name: angular-frontend
    restart: always
    ports:
      - "4200:4200"
    environment:
      - REST_API_URL=http://rest-typescript:3000
      - GRAPHQL_API_URL=http://graphql-service:5000/graphql
      - WEBSOCKET_URL=ws://websocket-server:8080

    depends_on:
      - rest-typescript
      - graphql-service
      - websocket-server
    networks:
      - app-net
    volumes:
      - ./frontend/virtual-queue-cms:/app
      - /app/node_modules

networks:
  app-net:
    driver: bridge

volumes:
  token-data:
    driver: local
