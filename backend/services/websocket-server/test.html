<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Test WebSocket Fila Virtual</title>
</head>
<body>
  <h2>Fila Virtual - Test WebSocket</h2>
  <p>Abre dos pesta√±as: una como Usuario y otra como Admin.</p>

  <button id="pedirCita">Pedir cita</button>
  <div id="log"></div>

  <script>
    let jwt = "<JWT_CORTO_DEL_USUARIO>";
    const refreshToken = "<REFRESH_TOKEN_DEL_USUARIO>";

    // Conexi√≥n WS
    let socket;
    function conectarWS(token) {
      socket = new WebSocket(`ws://localhost:8080/ws?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NjE1MDkxOTksInJvbCI6ImNsaWVudGUiLCJ1c2VyX2lkIjoiY2xpZW50ZTIifQ.x5iWyMsr45bd6xbSzgb6not7pl1ypk7LGsVsaO21xoo`);

      socket.onopen = () => {
        log("‚úÖ Conectado al WS");
      };

      socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        log(`üì© Evento: ${msg.type}, Datos: ${JSON.stringify(msg.data)}`);
      };

      socket.onclose = async (event) => {
        log("‚ùå WS cerrado, intentando renovar JWT...");
        try {
          const res = await fetch("/refresh", {
            method: "GET",
            headers: { "Authorization": refreshToken }
          });
          const data = await res.json();
          jwt = data.token;
          log("üîÑ Nuevo JWT recibido, reconectando...");
          conectarWS(jwt);
        } catch (e) {
          log("‚ùå No se pudo renovar el JWT:", e);
        }
      };

      socket.onerror = (err) => {
        log("‚ö†Ô∏è Error WS:", err);
      };
    }

    function log(msg) {
      const div = document.getElementById("log");
      div.innerHTML += `<p>${msg}</p>`;
      console.log(msg);
    }

    // Conectar al cargar la p√°gina
    conectarWS(jwt);

    // Simula usuario pidiendo cita
    document.getElementById("pedirCita").addEventListener("click", () => {
      if (socket && socket.readyState === WebSocket.OPEN) {
        const message = {
          type: "nueva_cita",
          data: {
            usuario_id: "cliente1",
            servicio_id: "servicio1",
            hora_solicitada: new Date().toISOString()
          }
        };
        socket.send(JSON.stringify(message));
        log("‚û°Ô∏è Pedido de cita enviado al WS");
      } else {
        log("‚ö†Ô∏è WS no est√° conectado");
      }
    });
  </script>
</body>
</html>
